{% extends "base.html" %}

{% block title %}Logs - Paperless AutoFields{% endblock %}

{% block content %}
<h1>System-Logs</h1>

<div class="card">
    <h2>Live-Logs</h2>
    <div class="log-controls">
        <button class="btn" onclick="refreshLogs()">Aktualisieren</button>
        <button class="btn btn-secondary" onclick="clearDisplay()">Anzeige leeren</button>
        <button class="btn btn-secondary" onclick="downloadLogs()">Logs herunterladen</button>
        <label>
            <input type="checkbox" id="auto-refresh" checked> Auto-Refresh (30s)
        </label>
    </div>
    
    <div class="log-display">
        <pre id="log-content">{% for line in logs %}{{ line }}{% endfor %}</pre>
    </div>
</div>

<div class="card">
    <h2>Log-Filter</h2>
    <div class="log-filters">
        <div class="form-group">
            <label for="log-level">Log-Level</label>
            <select id="log-level" class="form-control" onchange="filterLogs()">
                <option value="">Alle</option>
                <option value="ERROR">ERROR</option>
                <option value="WARNING">WARNING</option>
                <option value="INFO">INFO</option>
                <option value="DEBUG">DEBUG</option>
            </select>
        </div>
        <div class="form-group">
            <label for="search-term">Suchbegriff</label>
            <input type="text" id="search-term" class="form-control" 
                   placeholder="Nach Text suchen..." onkeyup="filterLogs()">
        </div>
        <div class="form-group">
            <label for="date-filter">Datum</label>
            <input type="date" id="date-filter" class="form-control" onchange="filterLogs()">
        </div>
    </div>
</div>

<style>
    .log-controls {
        margin-bottom: 1rem;
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .log-display {
        background: #1a1a1a;
        color: #f0f0f0;
        border-radius: 5px;
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid #333;
    }
    
    .log-display pre {
        margin: 0;
        padding: 1rem;
        background: transparent;
        color: inherit;
        border: none;
        font-family: 'Courier New', 'Consolas', monospace;
        font-size: 0.85rem;
        line-height: 1.4;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    .log-filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    /* Log-Level Highlighting */
    .log-line {
        margin: 2px 0;
        padding: 2px 0;
    }
    
    .log-line.error {
        background-color: rgba(220, 53, 69, 0.1);
        border-left: 3px solid #dc3545;
        padding-left: 8px;
    }
    
    .log-line.warning {
        background-color: rgba(255, 193, 7, 0.1);
        border-left: 3px solid #ffc107;
        padding-left: 8px;
    }
    
    .log-line.info {
        background-color: rgba(13, 202, 240, 0.1);
        border-left: 3px solid #0dcaf0;
        padding-left: 8px;
    }
    
    .log-line.debug {
        background-color: rgba(108, 117, 125, 0.1);
        border-left: 3px solid #6c757d;
        padding-left: 8px;
    }
    
    .highlight {
        background-color: yellow;
        color: black;
        padding: 1px 2px;
        border-radius: 2px;
    }
    
    @media (max-width: 768px) {
        .log-controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .log-filters {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let autoRefreshInterval;
    let originalLogContent = '';
    
    function refreshLogs() {
        fetch('/logs')
            .then(response => response.text())
            .then(html => {
                // Extrahiere Log-Inhalt aus der Response
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const logContent = doc.getElementById('log-content');
                if (logContent) {
                    originalLogContent = logContent.textContent;
                    document.getElementById('log-content').textContent = originalLogContent;
                    applyLogFormatting();
                    filterLogs(); // Filter erneut anwenden
                }
                
                // Scroll zum Ende
                const logDisplay = document.querySelector('.log-display');
                logDisplay.scrollTop = logDisplay.scrollHeight;
            })
            .catch(error => {
                console.error('Fehler beim Laden der Logs:', error);
            });
    }
    
    function clearDisplay() {
        document.getElementById('log-content').textContent = '';
    }
    
    function downloadLogs() {
        // Aktuelle Logs als Datei herunterladen
        const content = document.getElementById('log-content').textContent;
        const blob = new Blob([content], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `paperless-autofields-logs-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }
    
    function applyLogFormatting() {
        const logContent = document.getElementById('log-content');
        const lines = logContent.textContent.split('\n');
        
        let formattedHTML = '';
        lines.forEach(line => {
            let cssClass = 'log-line';
            
            // Bestimme Log-Level
            if (line.includes('ERROR')) {
                cssClass += ' error';
            } else if (line.includes('WARNING')) {
                cssClass += ' warning';
            } else if (line.includes('INFO')) {
                cssClass += ' info';
            } else if (line.includes('DEBUG')) {
                cssClass += ' debug';
            }
            
            formattedHTML += `<div class="${cssClass}">${escapeHtml(line)}</div>`;
        });
        
        logContent.innerHTML = formattedHTML;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function filterLogs() {
        const logLevel = document.getElementById('log-level').value;
        const searchTerm = document.getElementById('search-term').value.toLowerCase();
        const dateFilter = document.getElementById('date-filter').value;
        
        const logLines = document.querySelectorAll('.log-line');
        
        logLines.forEach(line => {
            const lineText = line.textContent.toLowerCase();
            let show = true;
            
            // Log-Level Filter
            if (logLevel && !lineText.includes(logLevel.toLowerCase())) {
                show = false;
            }
            
            // Suchbegriff Filter
            if (searchTerm && !lineText.includes(searchTerm)) {
                show = false;
            }
            
            // Datum Filter
            if (dateFilter && !lineText.includes(dateFilter)) {
                show = false;
            }
            
            line.style.display = show ? 'block' : 'none';
            
            // Highlight Suchbegriff
            if (show && searchTerm) {
                const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
                line.innerHTML = line.textContent.replace(regex, '<span class="highlight">$1</span>');
            }
        });
    }
    
    function escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
    
    function setupAutoRefresh() {
        const checkbox = document.getElementById('auto-refresh');
        
        function toggleAutoRefresh() {
            if (checkbox.checked) {
                autoRefreshInterval = setInterval(refreshLogs, 30000);
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }
        
        checkbox.addEventListener('change', toggleAutoRefresh);
        toggleAutoRefresh(); // Initial setup
    }
    
    // Initialisierung
    document.addEventListener('DOMContentLoaded', function() {
        // Originalen Content speichern
        originalLogContent = document.getElementById('log-content').textContent;
        
        // Log-Formatierung anwenden
        applyLogFormatting();
        
        // Auto-Refresh einrichten
        setupAutoRefresh();
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey || event.metaKey) {
                switch (event.key) {
                    case 'r':
                        event.preventDefault();
                        refreshLogs();
                        break;
                    case 'f':
                        event.preventDefault();
                        document.getElementById('search-term').focus();
                        break;
                }
            }
        });
        
        // Scroll zum Ende beim Laden
        const logDisplay = document.querySelector('.log-display');
        logDisplay.scrollTop = logDisplay.scrollHeight;
    });
    
    // Cleanup beim Verlassen der Seite
    window.addEventListener('beforeunload', function() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
    });
</script>
{% endblock %}
