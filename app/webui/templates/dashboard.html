{% extends "base.html" %}

{% block title %}Dashboard - Paperless AutoFields{% endblock %}

{% block content %}
<h1>Dashboard</h1>

<div class="stats-grid">
    <div class="stat-card">
        <span class="stat-number">{{ stats.total_documents }}</span>
        <div class="stat-label">Dokumente ({{ stats.document_type }})</div>
    </div>
    <div class="stat-card">
        <span class="stat-number">{{ stats.custom_fields }}</span>
        <div class="stat-label">Custom Fields</div>
    </div>
    <div class="stat-card">
        <span class="stat-number">{{ stats.patterns }}</span>
        <div class="stat-label">Konfigurierte Patterns</div>
    </div>
    <div class="stat-card">
        <span class="stat-number" id="status-indicator">●</span>
        <div class="stat-label">System Status</div>
    </div>
</div>

<div class="card">
    <h2>Aktionen</h2>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button class="btn" onclick="processAllDocuments()">Alle Dokumente verarbeiten</button>
        <button class="btn btn-secondary" onclick="reloadPatterns()">Patterns neu laden</button>
        <a href="/logs" class="btn btn-secondary">Logs anzeigen</a>
        <button class="btn" onclick="testConnection()">Verbindung testen</button>
    </div>
</div>

<div class="card">
    <h2>Letzte Aktivitäten</h2>
    <div id="recent-activities">
        <p>Lade Aktivitäten...</p>
    </div>
</div>

<div class="card">
    <h2>Quick Actions</h2>
    <form onsubmit="return processDocument(event)">
        <div style="display: flex; gap: 1rem; align-items: end; flex-wrap: wrap;">
            <div class="form-group" style="flex: 1; min-width: 200px;">
                <label for="doc-id">Dokument-ID</label>
                <input type="number" id="doc-id" class="form-control" placeholder="z.B. 123" required>
            </div>
            <div class="form-group">
                <button type="submit" class="btn">Dokument verarbeiten</button>
            </div>
        </div>
    </form>
</div>

<div class="card">
    <h2>Pattern Tester</h2>
    <form onsubmit="return testPattern(event)">
        <div class="form-group">
            <label for="pattern-field">Feld</label>
            <select id="pattern-field" class="form-control">
                <option value="">Lade Patterns...</option>
            </select>
        </div>
        <div class="form-group">
            <label for="test-text">Test-Text</label>
            <textarea id="test-text" class="form-control" placeholder="Hier den zu testenden Text eingeben..."></textarea>
        </div>
        <button type="submit" class="btn">Pattern testen</button>
        <div id="pattern-result" style="margin-top: 1rem;"></div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Dashboard-spezifische JavaScript-Funktionen
    
    async function checkSystemStatus() {
        try {
            const response = await fetch('/health');
            const status = await response.json();
            const indicator = document.getElementById('status-indicator');
            
            if (status.status === 'healthy') {
                indicator.style.color = '#48bb78';
                indicator.title = 'System läuft';
            } else {
                indicator.style.color = '#f56565';
                indicator.title = 'System-Fehler';
            }
        } catch (error) {
            const indicator = document.getElementById('status-indicator');
            indicator.style.color = '#f56565';
            indicator.title = 'Verbindungsfehler';
        }
    }
    
    async function loadPatterns() {
        try {
            const response = await fetch('/api/patterns');
            const patterns = await response.json();
            const select = document.getElementById('pattern-field');
            
            select.innerHTML = '<option value="">Pattern auswählen...</option>';
            for (const [name, info] of Object.entries(patterns)) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = `${name} - ${info.description || 'Keine Beschreibung'}`;
                select.appendChild(option);
            }
        } catch (error) {
            console.error('Fehler beim Laden der Patterns:', error);
        }
    }
    
    async function processAllDocuments() {
        if (!confirm('Alle Dokumente verarbeiten? Dies kann einige Zeit dauern.')) {
            return;
        }
        
        try {
            // Hier würde die API für Batch-Verarbeitung aufgerufen
            alert('Verarbeitung gestartet. Siehe Logs für Details.');
        } catch (error) {
            alert('Fehler bei der Verarbeitung: ' + error.message);
        }
    }
    
    async function reloadPatterns() {
        try {
            // Patterns neu laden (würde eine API-Route benötigen)
            alert('Patterns wurden neu geladen.');
            loadPatterns(); // UI aktualisieren
        } catch (error) {
            alert('Fehler beim Neuladen: ' + error.message);
        }
    }
    
    async function testConnection() {
        try {
            const response = await fetch('/health');
            const status = await response.json();
            
            if (status.status === 'healthy') {
                alert('Verbindung OK ✓\nAPI: ' + (status.api_connected ? 'Verbunden' : 'Fehler') + 
                      '\nPatterns: ' + (status.patterns_loaded ? 'Geladen' : 'Fehler'));
            } else {
                alert('Verbindung fehlgeschlagen: ' + status.error);
            }
        } catch (error) {
            alert('Verbindungsfehler: ' + error.message);
        }
    }
    
    async function processDocument(event) {
        event.preventDefault();
        const docId = document.getElementById('doc-id').value;
        
        if (!docId) {
            alert('Bitte Dokument-ID eingeben');
            return false;
        }
        
        try {
            const response = await fetch(`/api/process-document/${docId}`, {
                method: 'POST'
            });
            const result = await response.json();
            
            if (result.success) {
                const fields = Object.entries(result.extracted_fields);
                if (fields.length > 0) {
                    alert(`Dokument ${docId} verarbeitet!\n\nExtrahierte Felder:\n` + 
                          fields.map(([k, v]) => `${k}: ${v}`).join('\n'));
                } else {
                    alert(`Dokument ${docId} verarbeitet, aber keine Felder gefunden.`);
                }
            } else {
                alert('Fehler: ' + result.error);
            }
        } catch (error) {
            alert('Fehler bei der Verarbeitung: ' + error.message);
        }
        
        return false;
    }
    
    async function testPattern(event) {
        event.preventDefault();
        const field = document.getElementById('pattern-field').value;
        const text = document.getElementById('test-text').value;
        const resultDiv = document.getElementById('pattern-result');
        
        if (!field || !text) {
            alert('Bitte Feld und Text eingeben');
            return false;
        }
        
        try {
            const response = await fetch('/api/test-pattern', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    field_name: field,
                    test_text: text
                })
            });
            const result = await response.json();
            
            if (result.found) {
                resultDiv.innerHTML = `<div class="alert alert-success">✓ Gefunden: <strong>${result.result}</strong></div>`;
            } else {
                resultDiv.innerHTML = `<div class="alert alert-warning">Kein Match gefunden</div>`;
            }
        } catch (error) {
            resultDiv.innerHTML = `<div class="alert alert-error">Fehler: ${error.message}</div>`;
        }
        
        return false;
    }
    
    // Initialisierung beim Laden der Seite
    document.addEventListener('DOMContentLoaded', function() {
        checkSystemStatus();
        loadPatterns();
        
        // Status alle 30 Sekunden aktualisieren
        setInterval(checkSystemStatus, 30000);
    });
</script>
{% endblock %}
